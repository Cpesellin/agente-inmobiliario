<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>InmoAgent Pro</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=Nunito:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg:#0c0f1a; --s1:#121627; --s2:#1a2035; --s3:#222840; --border:#2a3050;
  --gold:#e8b86d; --gold2:#f5d08a; --goldd:rgba(232,184,109,0.12);
  --green:#34d399; --greend:rgba(52,211,153,0.12);
  --blue:#60a5fa; --blued:rgba(96,165,250,0.12);
  --orange:#fb923c; --oranged:rgba(251,146,60,0.12);
  --purple:#a78bfa; --red:#f87171;
  --text:#e8eaf0; --muted:#8892aa; --dim:#4a5268; --r:14px;
}
*{margin:0;padding:0;box-sizing:border-box}
html{scroll-behavior:smooth}
body{font-family:'Nunito',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden}
body::before{content:'';position:fixed;inset:0;background:radial-gradient(ellipse 80% 50% at 20% -10%,rgba(232,184,109,0.06),transparent),radial-gradient(ellipse 60% 40% at 80% 110%,rgba(96,165,250,0.04),transparent);pointer-events:none;z-index:0}

/* HERO */
.hero{position:relative;z-index:1;text-align:center;padding:56px 24px 40px;border-bottom:1px solid var(--border)}
.hero-logo{display:inline-flex;align-items:center;gap:10px;background:var(--s2);border:1px solid var(--border);border-radius:20px;padding:8px 20px;margin-bottom:28px}
.hero-logo span{font-family:'Syne',sans-serif;font-weight:800;font-size:14px;letter-spacing:2px;text-transform:uppercase;color:var(--gold)}
.hero h1{font-family:'Syne',sans-serif;font-size:clamp(30px,5vw,54px);font-weight:800;line-height:1.05;letter-spacing:-1.5px;margin-bottom:12px}
.hero h1 em{font-style:normal;color:var(--gold)}
.hero p{font-size:15px;color:var(--muted);font-weight:300;max-width:480px;margin:0 auto}
.hero-stats{display:flex;justify-content:center;gap:36px;margin-top:32px;flex-wrap:wrap}
.hs{text-align:center}
.hs-num{font-family:'Syne',sans-serif;font-size:30px;font-weight:800;color:var(--gold);line-height:1}
.hs-label{font-size:11px;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-top:3px}

/* APP */
.app{position:relative;z-index:1;max-width:1200px;margin:0 auto;padding:32px 20px 80px}

/* PANEL */
.panel{background:var(--s1);border:1px solid var(--border);border-radius:20px;padding:28px;margin-bottom:24px}
.ph{display:flex;align-items:center;gap:14px;margin-bottom:20px}
.pi{width:44px;height:44px;border-radius:12px;background:var(--goldd);border:1px solid rgba(232,184,109,0.2);display:flex;align-items:center;justify-content:center;font-size:20px;flex-shrink:0}
.pi.g{background:var(--greend);border-color:rgba(52,211,153,0.2)}
.pt{font-family:'Syne',sans-serif;font-size:18px;font-weight:700;color:var(--gold)}
.pt.g{color:var(--green)}
.ps{font-size:13px;color:var(--muted);margin-top:2px}

/* TEXTAREA */
textarea{width:100%;min-height:150px;padding:16px;border:1.5px solid var(--border);border-radius:12px;background:var(--s2);color:var(--text);font-family:'Courier New',monospace;font-size:12px;resize:vertical;line-height:1.6;transition:border-color 0.2s}
textarea:focus{outline:none;border-color:var(--gold)}
textarea::placeholder{color:var(--dim)}

/* BTN */
.btn{display:flex;align-items:center;justify-content:center;gap:8px;width:100%;padding:14px;border:none;border-radius:12px;background:linear-gradient(135deg,var(--gold),var(--gold2));color:#0c0f1a;font-family:'Syne',sans-serif;font-size:15px;font-weight:700;cursor:pointer;transition:all 0.2s;margin-top:14px;letter-spacing:0.3px}
.btn:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(232,184,109,0.3)}
.btn.g{background:linear-gradient(135deg,var(--green),#6ee7b7);color:#0c0f1a}
.btn.g:hover{box-shadow:0 8px 24px rgba(52,211,153,0.3)}
.btn.ghost{background:var(--s2);color:var(--muted);box-shadow:none;border:1px solid var(--border)}
.btn.ghost:hover{border-color:var(--muted);transform:none;box-shadow:none}

/* INFO */
.info{background:var(--goldd);border:1px solid rgba(232,184,109,0.2);border-radius:12px;padding:14px 16px;font-size:13px;color:var(--gold2);line-height:1.7;margin-top:14px}

/* TOAST */
.toast{display:inline-flex;align-items:center;gap:8px;padding:10px 16px;border-radius:10px;font-size:13px;font-weight:600;margin-top:12px;animation:tin 0.3s ease}
@keyframes tin{from{opacity:0;transform:translateY(-6px)}to{opacity:1;transform:translateY(0)}}
.tok{background:var(--greend);color:var(--green);border:1.5px solid rgba(52,211,153,0.4)}
.terr{background:rgba(248,113,113,0.12);color:var(--red);border:1.5px solid rgba(248,113,113,0.4)}

/* â•â• FILTERS â•â• */
.fgrid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
@media(max-width:640px){.fgrid{grid-template-columns:1fr}}
.fsec{background:var(--s2);border:1px solid var(--border);border-radius:14px;padding:18px}
.fsec.full{grid-column:1/-1}
.flabel{font-size:10px;font-weight:700;letter-spacing:1.8px;text-transform:uppercase;color:var(--muted);margin-bottom:12px;display:flex;align-items:center;gap:6px}

/* CHIPS */
.chips{display:flex;flex-wrap:wrap;gap:8px}
.chip{display:inline-flex;align-items:center;gap:5px;padding:7px 14px;border-radius:20px;font-size:13px;font-weight:600;cursor:pointer;border:1.5px solid var(--border);background:transparent;color:var(--muted);transition:all 0.15s;user-select:none;white-space:nowrap}
.chip:hover{border-color:var(--gold);color:var(--gold);background:var(--goldd)}
.chip.on{border-color:var(--gold);color:var(--gold);background:var(--goldd)}
.chip.on.cg{border-color:var(--green);color:var(--green);background:var(--greend)}
.chip.on.cb{border-color:var(--blue);color:var(--blue);background:var(--blued)}
.chip.on.co{border-color:var(--orange);color:var(--orange);background:var(--oranged)}
.chip.on.cp{border-color:var(--purple);color:var(--purple);background:rgba(167,139,250,0.12)}

/* ACTIVE TAGS */
.atags{display:flex;flex-wrap:wrap;gap:6px;margin-top:14px;min-height:4px}
.atag{display:inline-flex;align-items:center;gap:5px;background:var(--goldd);border:1px solid rgba(232,184,109,0.3);color:var(--gold);border-radius:20px;padding:4px 10px;font-size:12px;font-weight:600}
.atag .x{cursor:pointer;opacity:0.6;font-size:13px}
.atag .x:hover{opacity:1}

/* SEARCH INPUT */
.sinput-wrap{position:relative;margin-top:14px}
.sinput{width:100%;padding:15px 56px 15px 48px;border:1.5px solid var(--border);border-radius:12px;background:var(--s2);color:var(--text);font-family:'Nunito',sans-serif;font-size:15px;transition:all 0.2s}
.sinput:focus{outline:none;border-color:var(--gold)}
.sinput::placeholder{color:var(--dim)}
.sico{position:absolute;left:16px;top:50%;transform:translateY(-50%);font-size:18px;pointer-events:none}
.sgo{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:var(--gold);border:none;border-radius:8px;width:38px;height:38px;display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;transition:all 0.2s;color:#0c0f1a}
.sgo:hover{background:var(--gold2);transform:translateY(-50%) scale(1.08)}

/* RESULTS */
.rhead{display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:10px}
.rcount{font-family:'Syne',sans-serif;font-size:20px;font-weight:700}
.rcount b{color:var(--green)}
.rsort{font-size:12px;color:var(--muted);background:var(--s1);border:1px solid var(--border);padding:6px 12px;border-radius:8px}

/* GRID */
.pgrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(310px,1fr));gap:20px}

/* PROPERTY CARD */
.pc{background:var(--s1);border:1px solid var(--border);border-radius:20px;overflow:hidden;transition:all 0.25s;animation:cup 0.4s ease both}
@keyframes cup{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}
.pc:hover{border-color:var(--gold);transform:translateY(-5px);box-shadow:0 16px 48px rgba(0,0,0,0.5)}
.pctop{padding:20px;position:relative;overflow:hidden}
.pctop::after{content:'';position:absolute;bottom:-35px;right:-35px;width:130px;height:130px;border-radius:50%;background:rgba(255,255,255,0.04)}
.pctop.tv{background:linear-gradient(135deg,#1e3a5f,#1d4ed8)}
.pctop.ta{background:linear-gradient(135deg,#064e3b,#059669)}
.pctop.tb{background:linear-gradient(135deg,#431407,#c2410c)}
.pcemoji{font-size:30px;margin-bottom:8px;position:relative;z-index:1}
.pctipo{font-size:10px;font-weight:700;letter-spacing:2px;text-transform:uppercase;color:rgba(255,255,255,0.6);position:relative;z-index:1;margin-bottom:3px}
.pcdir{font-size:14px;font-weight:700;color:#fff;line-height:1.3;position:relative;z-index:1;margin-bottom:3px}
.pccity{font-size:12px;color:rgba(255,255,255,0.75);position:relative;z-index:1}
.pccod{position:absolute;top:12px;right:12px;font-size:10px;background:rgba(0,0,0,0.35);color:rgba(255,255,255,0.8);padding:3px 8px;border-radius:6px;font-family:'Courier New',monospace;z-index:1}

/* CARD BODY */
.pcbody{padding:18px 20px}
.mods{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:12px}
.mbadge{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:7px;font-size:11px;font-weight:700}
.mbv{background:var(--blued);color:var(--blue);border:1px solid rgba(96,165,250,0.3)}
.mba{background:var(--greend);color:var(--green);border:1px solid rgba(52,211,153,0.3)}
.mbok{background:var(--greend);color:var(--green);border:1px solid rgba(52,211,153,0.3)}
.mbst{background:rgba(248,113,113,0.1);color:var(--red);border:1px solid rgba(248,113,113,0.25)}

/* PRICES */
.pblock{margin:10px 0}
.pventa{font-family:'Syne',sans-serif;font-size:22px;font-weight:800;color:var(--blue);line-height:1}
.pventa small{font-size:11px;font-weight:400;color:var(--muted);font-family:'Nunito',sans-serif}
.parriendo{font-size:15px;font-weight:700;color:var(--green);margin-top:4px}
.parriendo small{font-size:11px;font-weight:400;color:var(--muted)}
/* Cross indicator - when viewing rents but property also for sale */
.cross-v{display:inline-flex;align-items:center;gap:5px;background:var(--blued);border:1px solid rgba(96,165,250,0.3);border-radius:7px;padding:4px 10px;font-size:11px;font-weight:700;color:var(--blue);margin-top:5px}
.cross-a{display:inline-flex;align-items:center;gap:5px;background:var(--greend);border:1px solid rgba(52,211,153,0.3);border-radius:7px;padding:4px 10px;font-size:11px;font-weight:700;color:var(--green);margin-top:5px}
.admon{font-size:12px;color:var(--muted);margin-top:3px}

/* SPECS */
.specs{display:flex;flex-wrap:wrap;gap:6px;margin-top:12px;padding-top:12px;border-top:1px solid var(--border)}
.spec{font-size:12px;color:var(--muted);background:var(--s2);padding:4px 10px;border-radius:7px;display:flex;align-items:center;gap:4px}

/* DUAL ALERT */
.dalert{background:var(--oranged);border:1px solid rgba(251,146,60,0.3);border-radius:10px;padding:10px 14px;font-size:12px;color:var(--orange);margin-top:10px;line-height:1.5}

/* OBS */
.obs{background:var(--s2);border-radius:8px;padding:8px 12px;font-size:11px;color:var(--dim);margin-top:8px;line-height:1.5;border-left:2px solid var(--border)}

/* ASESOR */
.asesor{font-size:12px;color:var(--muted);margin-top:8px}

/* EMPTY */
.empty{text-align:center;padding:70px 20px;background:var(--s1);border:1px solid var(--border);border-radius:20px}
.empty-ico{font-size:64px;display:block;margin-bottom:16px}
.empty h3{font-family:'Syne',sans-serif;font-size:22px;font-weight:700;color:var(--gold);margin-bottom:8px}
.empty p{color:var(--muted)}

/* LOADER */
.loader{text-align:center;padding:50px}
.ldots{display:inline-flex;gap:8px}
.ldot{width:12px;height:12px;border-radius:50%;background:var(--gold);animation:lb 1.2s infinite ease-in-out}
.ldot:nth-child(1){animation-delay:-0.24s}.ldot:nth-child(2){animation-delay:-0.12s}
@keyframes lb{0%,80%,100%{transform:scale(0.7);opacity:0.3}40%{transform:scale(1.2);opacity:1}}

@media(max-width:640px){.pgrid{grid-template-columns:1fr}.hero h1{font-size:28px}.panel{padding:18px}.hero-stats{gap:20px}}
</style>
</head>
<body>

<!-- HERO -->
<div class="hero">
  <div class="hero-logo">ğŸ  <span>InmoAgent Pro</span></div>
  <h1>Tu Asistente<br><em>Inmobiliario</em> Inteligente</h1>
  <p>Consultas instantÃ¡neas Â· Base de datos en tiempo real Â· Para profesionales</p>
  <div class="hero-stats">
    <div class="hs"><div class="hs-num" id="hs1">â€”</div><div class="hs-label">Total</div></div>
    <div class="hs"><div class="hs-num" id="hs2">â€”</div><div class="hs-label">En Venta</div></div>
    <div class="hs"><div class="hs-num" id="hs3">â€”</div><div class="hs-label">En Arriendo</div></div>
    <div class="hs"><div class="hs-num" id="hs4">â€”</div><div class="hs-label">Doble Modalidad</div></div>
  </div>
</div>

<div class="app">

<!-- PASO 1 -->
<div class="panel">
  <div class="ph">
    <div class="pi">ğŸ“‹</div>
    <div><div class="pt">Paso 1 Â· Cargar Base de Datos</div>
    <div class="ps">Google Sheets â†’ Archivo â†’ Descargar â†’ CSV â†’ Bloc de Notas â†’ Ctrl+A â†’ Ctrl+C â†’ Pegar aquÃ­</div></div>
  </div>
  <textarea id="csv" placeholder="Pega aquÃ­ el contenido completo del CSV..."></textarea>
  <button class="btn" onclick="cargar()">âœ… Cargar Base de Datos</button>
  <div id="st"></div>
  <div class="info">ğŸ’¡ <strong>Columnas detectadas automÃ¡ticamente:</strong> Tipo de Inmueble, Tipo de NegociaciÃ³n, Ciudad, Precio de Venta, Precio de Arriendo, DirecciÃ³n, Asesor, Observaciones y mÃ¡s.</div>
</div>

<!-- PASO 2: FILTROS -->
<div class="panel">
  <div class="ph">
    <div class="pi g">ğŸ”</div>
    <div><div class="pt g">Paso 2 Â· Filtros de BÃºsqueda</div>
    <div class="ps">SelecciÃ³n mÃºltiple en todos los filtros Â· Combinaciones ilimitadas</div></div>
  </div>

  <div class="fgrid">

    <!-- NEGOCIACIÃ“N -->
    <div class="fsec">
      <div class="flabel">ğŸ’° Tipo de NegociaciÃ³n</div>
      <div class="chips">
        <div class="chip" data-g="neg" data-v="venta" onclick="toggle(this,'cg')">ğŸ’° Venta</div>
        <div class="chip" data-g="neg" data-v="arriendo" onclick="toggle(this,'cb')">ğŸ”‘ Arriendo</div>
        <div class="chip" data-g="neg" data-v="ambas" onclick="toggle(this,'co')">ğŸ”„ Venta + Arriendo</div>
      </div>
    </div>

    <!-- CIUDAD -->
    <div class="fsec">
      <div class="flabel">ğŸ“ Ciudad</div>
      <div class="chips">
        <div class="chip" data-g="ciu" data-v="pereira" onclick="toggle(this)">Pereira</div>
        <div class="chip" data-g="ciu" data-v="dosquebradas" onclick="toggle(this)">Dosquebradas</div>
        <div class="chip" data-g="ciu" data-v="santa rosa" onclick="toggle(this)">Santa Rosa</div>
        <div class="chip" data-g="ciu" data-v="alcala" onclick="toggle(this)">AlcalÃ¡</div>
      </div>
    </div>

    <!-- TIPO INMUEBLE -->
    <div class="fsec full">
      <div class="flabel">ğŸ  Tipo de Inmueble <span style="font-size:10px;font-weight:400">(selecciÃ³n mÃºltiple)</span></div>
      <div class="chips">
        <div class="chip" data-g="tipo" data-v="apartamento" onclick="toggle(this)">ğŸ¢ Apartamento</div>
        <div class="chip" data-g="tipo" data-v="aparta estudio" onclick="toggle(this)">ğŸ  Apartaestudio</div>
        <div class="chip" data-g="tipo" data-v="casa" onclick="toggle(this,'cp')">ğŸ¡ Casa</div>
        <div class="chip" data-g="tipo" data-v="casa campestre" onclick="toggle(this,'cp')">ğŸŒ¿ Casa Campestre</div>
        <div class="chip" data-g="tipo" data-v="finca" onclick="toggle(this,'cg')">ğŸŒ¾ Finca</div>
        <div class="chip" data-g="tipo" data-v="local" onclick="toggle(this,'co')">ğŸª Local Comercial</div>
        <div class="chip" data-g="tipo" data-v="oficina" onclick="toggle(this,'cb')">ğŸ’¼ Oficina</div>
        <div class="chip" data-g="tipo" data-v="bodega" onclick="toggle(this)">ğŸ­ Bodega</div>
        <div class="chip" data-g="tipo" data-v="lote" onclick="toggle(this,'cg')">ğŸŒ³ Lote</div>
        <div class="chip" data-g="tipo" data-v="penthouse" onclick="toggle(this,'co')">ğŸ‘‘ Penthouse</div>
      </div>
    </div>

    <!-- PRECIO ARRIENDO -->
    <div class="fsec">
      <div class="flabel">ğŸ”‘ Precio Arriendo <span style="font-size:10px;font-weight:400">(mÃºltiple)</span></div>
      <div class="chips">
        <div class="chip" data-g="parr" data-v="1000000-1500000" onclick="toggle(this,'cb')">$1M â€“ $1.5M</div>
        <div class="chip" data-g="parr" data-v="1500000-2000000" onclick="toggle(this,'cb')">$1.5M â€“ $2M</div>
        <div class="chip" data-g="parr" data-v="2000000-999999999" onclick="toggle(this,'cb')">$2M en adelante</div>
      </div>
    </div>

    <!-- PRECIO VENTA -->
    <div class="fsec">
      <div class="flabel">ğŸ’° Precio Venta <span style="font-size:10px;font-weight:400">(mÃºltiple)</span></div>
      <div class="chips">
        <div class="chip" data-g="pven" data-v="0-200000000" onclick="toggle(this,'cg')">Hasta $200M</div>
        <div class="chip" data-g="pven" data-v="200000000-500000000" onclick="toggle(this,'cg')">$200M â€“ $500M</div>
        <div class="chip" data-g="pven" data-v="500000000-9999999999" onclick="toggle(this,'cg')">$500M en adelante</div>
      </div>
    </div>

  </div>

  <!-- FILTROS ACTIVOS -->
  <div class="atags" id="atags"></div>

  <!-- BÃšSQUEDA LIBRE -->
  <div class="sinput-wrap">
    <span class="sico">âœï¸</span>
    <input class="sinput" id="q" placeholder="O escribe libremente: ej. Casa con piscina en Cerritos..." onkeypress="if(event.key==='Enter')buscar()">
    <button class="sgo" onclick="buscar()">ğŸš€</button>
  </div>

  <button class="btn g" onclick="buscar()" style="margin-top:16px">ğŸ” Buscar Predios</button>
  <button class="btn ghost" onclick="limpiar()">ğŸ—‘ï¸ Limpiar Todo</button>
</div>

<!-- RESULTADOS -->
<div id="res"></div>

</div>

<script>
let D=[];
const F={neg:new Set(),ciu:new Set(),tipo:new Set(),parr:new Set(),pven:new Set()};

const LABELS={
  neg:{venta:'ğŸ’° Venta',arriendo:'ğŸ”‘ Arriendo',ambas:'ğŸ”„ Ambas'},
  ciu:{pereira:'ğŸ“ Pereira',dosquebradas:'ğŸ“ Dosquebradas','santa rosa':'ğŸ“ Santa Rosa',alcala:'ğŸ“ AlcalÃ¡'},
  tipo:{apartamento:'ğŸ¢ Apartamento','aparta estudio':'ğŸ  Apartaestudio',casa:'ğŸ¡ Casa','casa campestre':'ğŸŒ¿ Casa Campestre',finca:'ğŸŒ¾ Finca',local:'ğŸª Local',oficina:'ğŸ’¼ Oficina',bodega:'ğŸ­ Bodega',lote:'ğŸŒ³ Lote',penthouse:'ğŸ‘‘ Penthouse'},
  parr:{'1000000-1500000':'ğŸ”‘ $1Mâ€“$1.5M','1500000-2000000':'ğŸ”‘ $1.5Mâ€“$2M','2000000-999999999':'ğŸ”‘ $2M+'},
  pven:{'0-200000000':'ğŸ’° Hasta $200M','200000000-500000000':'ğŸ’° $200Mâ€“$500M','500000000-9999999999':'ğŸ’° $500M+'}
};

function toggle(el,cc=''){
  const g=el.dataset.g,v=el.dataset.v;
  if(F[g].has(v)){F[g].delete(v);el.classList.remove('on','cg','cb','co','cp');}
  else{F[g].add(v);el.classList.add('on');if(cc)el.classList.add(cc);}
  renderTags();
}

function renderTags(){
  let h='';
  for(const[g,s]of Object.entries(F))for(const v of s){
    const l=LABELS[g]?.[v]||v;
    h+=`<span class="atag">${l}<span class="x" onclick="removeF('${g}','${v}')">âœ•</span></span>`;
  }
  document.getElementById('atags').innerHTML=h;
}

function removeF(g,v){
  F[g].delete(v);
  document.querySelectorAll(`.chip[data-g="${g}"][data-v="${v}"]`).forEach(e=>e.classList.remove('on','cg','cb','co','cp'));
  renderTags();
}

function limpiar(){
  for(const g of Object.keys(F))F[g].clear();
  document.querySelectorAll('.chip').forEach(e=>e.classList.remove('on','cg','cb','co','cp'));
  document.getElementById('q').value='';
  document.getElementById('atags').innerHTML='';
  document.getElementById('res').innerHTML='';
}

// CSV PARSER ROBUSTO - maneja comillas y comas dentro de campos
function parseCSVLine(line){
  const r=[];let cur='';let inQ=false;
  for(let i=0;i<line.length;i++){
    if(line[i]==='"'){inQ=!inQ;continue;}
    if(line[i]===','&&!inQ){r.push(cur.trim());cur='';continue;}
    cur+=line[i];
  }
  r.push(cur.trim());
  return r;
}

function cargar(){
  const csv=document.getElementById('csv').value.trim();
  const st=document.getElementById('st');
  if(!csv){st.innerHTML='<div class="toast terr">âš ï¸ Pega el CSV primero</div>';return;}
  try{
    const lines=csv.split('\n').filter(l=>l.trim().length>2);
    if(lines.length<2) throw new Error('El CSV parece vacÃ­o');
    const hdrs=parseCSVLine(lines[0]).map(h=>h.toLowerCase().trim().replace(/\s+/g,' '));
    D=[];
    for(let i=1;i<lines.length;i++){
      const vals=parseCSVLine(lines[i]);
      if(vals.length<3)continue;
      const obj={};
      hdrs.forEach((h,j)=>{obj[h]=(vals[j]||'').trim();});
      D.push(obj);
    }
    // Actualizar stats hero
    const vs=D.filter(p=>eV(p)&&!eA2(p)).length;
    const as=D.filter(p=>eA(p)&&!eA2(p)).length;
    const bs=D.filter(p=>eA2(p)).length;
    document.getElementById('hs1').textContent=D.length;
    document.getElementById('hs2').textContent=vs;
    document.getElementById('hs3').textContent=as;
    document.getElementById('hs4').textContent=bs;
    st.innerHTML=`<div class="toast tok">ğŸ‰ ${D.length} predios cargados exitosamente. Â¡A buscar! ğŸ‘‡</div>`;
    document.getElementById('csv').value='';
  }catch(e){st.innerHTML=`<div class="toast terr">âŒ Error: ${e.message}</div>`;}
}

// HELPERS - extrae valor ignorando N/A, SIN INFORMACION, etc.
const JUNK=['n/a','no aplica','no tiene','sin informacion','sin informaciÃ³n','notiene','no dice','pendiente','no aplica','sin contacto',''];
function get(obj,...keys){
  for(const k of keys)for(const h of Object.keys(obj)){
    if(h.toLowerCase().includes(k.toLowerCase())){
      const v=(obj[h]||'').trim();
      if(v&&!JUNK.includes(v.toLowerCase()))return v;
    }
  }
  return '';
}

function negocio(p){return(get(p,'tipo de negociaci','negociaci')||'').toLowerCase();}
function ciudad(p){return(get(p,'ubicaci','ciudad')||'').toLowerCase();}
function tipo(p){return(get(p,'tipo de inmueble','tipo')||'').toLowerCase();}

function eV(p){return negocio(p).includes('venta');}
function eA(p){const n=negocio(p);return n.includes('arriendo')||n.includes('renta');}
function eA2(p){return eV(p)&&eA(p);}// ambas modalidades

function num(v){if(!v)return 0;const n=parseFloat(String(v).replace(/[^\d.]/g,''));return isNaN(n)?0:n;}
function pVenta(p){return num(get(p,'precio de venta','precio venta'));}
function pArriendo(p){return num(get(p,'precio de arriendo','precio arriendo','canon'));}

function enRango(val,r){const[a,b]=r.split('-').map(Number);return val>=a&&val<=b;}

// â”€â”€ BUSCAR â”€â”€
function buscar(){
  const res=document.getElementById('res');
  const qv=document.getElementById('q').value.trim().toLowerCase();
  if(!D.length){
    res.innerHTML='<div class="empty"><span class="empty-ico">ğŸ“‹</span><h3>Sin datos</h3><p>Completa el Paso 1 primero</p></div>';return;
  }
  res.innerHTML='<div class="loader"><div class="ldots"><div class="ldot"></div><div class="ldot"></div><div class="ldot"></div></div><p style="margin-top:16px;color:var(--muted)">Buscando predios... âœ¨</p></div>';
  setTimeout(()=>{
    let lista=D.filter(p=>filtrar(p,qv));

    // Detectar si la consulta involucra precio para ordenar
    const hayPrecio=F.parr.size>0||F.pven.size>0||F.neg.size>0||/precio|arriendo|venta|bajo|hasta|desde|valor|\d+m/i.test(qv);
    const esConsultaArriendo=F.neg.has('arriendo')||F.parr.size>0||(/arriendo|renta/i.test(qv)&&!/\bventa\b/i.test(qv));

    if(hayPrecio){
      lista.sort((a,b)=>{
        // Precio principal segÃºn tipo de consulta
        const pa=esConsultaArriendo?(pArriendo(a)||pVenta(a)):(pVenta(a)||pArriendo(a));
        const pb=esConsultaArriendo?(pArriendo(b)||pVenta(b)):(pVenta(b)||pArriendo(b));
        return pb-pa; // MAYOR A MENOR
      });
    }

    render(lista,qv,hayPrecio,esConsultaArriendo);
  },300);
}

function filtrar(p,qv){
  const neg=negocio(p);
  const ciu=ciudad(p);
  const tip=tipo(p);
  const dir=(get(p,'direccion','direcciÃ³n')||'').toLowerCase();
  const pv=pVenta(p);
  const pa=pArriendo(p);

  // â”€â”€ NEGOCIACIÃ“N (OR) â”€â”€
  if(F.neg.size>0){
    let ok=false;
    if(F.neg.has('venta')&&eV(p))ok=true;
    if(F.neg.has('arriendo')&&eA(p))ok=true;
    if(F.neg.has('ambas')&&eA2(p))ok=true;
    if(!ok)return false;
  }

  // â”€â”€ CIUDAD (OR) â”€â”€
  if(F.ciu.size>0){
    let ok=false;
    for(const c of F.ciu)if(ciu.includes(c)||dir.includes(c))ok=true;
    if(!ok)return false;
  }

  // â”€â”€ TIPO (OR - multi-selecciÃ³n) â”€â”€
  if(F.tipo.size>0){
    let ok=false;
    for(const tv of F.tipo){
      if(tv==='aparta estudio'&&tip.includes('aparta')&&(tip.includes('estudio')||tip.includes('studio')))ok=true;
      else if(tv==='casa campestre'&&tip.includes('campestre'))ok=true;
      else if(tv!=='casa campestre'&&tv!=='aparta estudio'&&tip.includes(tv))ok=true;
    }
    if(!ok)return false;
  }

  // â”€â”€ RANGO ARRIENDO (OR entre rangos) â”€â”€
  if(F.parr.size>0){
    if(pa<=0)return false;
    let ok=false;
    for(const r of F.parr)if(enRango(pa,r))ok=true;
    if(!ok)return false;
  }

  // â”€â”€ RANGO VENTA (OR entre rangos) â”€â”€
  if(F.pven.size>0){
    if(pv<=0)return false;
    let ok=false;
    for(const r of F.pven)if(enRango(pv,r))ok=true;
    if(!ok)return false;
  }

  // â”€â”€ BÃšSQUEDA LIBRE â”€â”€
  if(qv){
    // Ciudad desde texto
    const CIUDADES=['pereira','dosquebradas','santa rosa','condina','cerritos','cuba','alcala','combia','pinares','manizales'];
    for(const c of CIUDADES)if(qv.includes(c)&&!ciu.includes(c)&&!dir.includes(c))return false;

    // Tipo desde texto
    if(/\bapartamento\b|apto\b/i.test(qv)&&!tip.includes('apartamento')&&!tip.includes('apto')&&!tip.includes('estudio'))return false;
    if(/apartaestudio|aparta.?estudio/i.test(qv)&&!tip.includes('estudio'))return false;
    if(/\bcasa\b/i.test(qv)&&!tip.includes('casa'))return false;
    if(/campestre/i.test(qv)&&!tip.includes('campestre'))return false;
    if(/\bfinca\b/i.test(qv)&&!tip.includes('finca'))return false;
    if(/\blocal\b/i.test(qv)&&!tip.includes('local'))return false;
    if(/\boficina\b/i.test(qv)&&!tip.includes('oficina'))return false;
    if(/\blote\b|terreno/i.test(qv)&&!tip.includes('lote')&&!tip.includes('terreno'))return false;
    if(/\bbodega\b/i.test(qv)&&!tip.includes('bodega'))return false;
    if(/penthouse/i.test(qv)&&!tip.includes('penthouse'))return false;

    // NegociaciÃ³n desde texto
    if(/\bventa\b/i.test(qv)&&!/arriendo|renta/i.test(qv)&&!eV(p))return false;
    if(/\barriendo\b|arrendar|alquiler/i.test(qv)&&!/\bventa\b/i.test(qv)&&!eA(p))return false;

    // Precio mÃ¡ximo desde texto
    const pmx=qv.match(/(?:bajo|hasta|mÃ¡ximo|max|menos de)\s*(\d+[\.,]?\d*)\s*(?:m|mill)?/i);
    if(pmx){
      const n=parseFloat(pmx[1].replace(',','.'));
      const maxP=n<10000?n*1000000:n;
      const precio=eA(p)?(pa||pv):(pv||pa);
      if(precio>0&&precio>maxP)return false;
    }
  }

  return true;
}

// â”€â”€ RENDER â”€â”€
function render(lista,qv,hayPrecio,esArriendo){
  const res=document.getElementById('res');
  if(!lista.length){
    res.innerHTML=`<div class="empty"><span class="empty-ico">ğŸ”</span><h3>Sin resultados</h3><p>Ajusta los filtros o intenta con otros criterios</p></div>`;return;
  }

  let h=`
    <div class="rhead">
      <div class="rcount">ğŸ¯ <b>${lista.length}</b> ${lista.length===1?'predio':'predios'} encontrado(s)</div>
      ${hayPrecio?`<div class="rsort">ğŸ“Š Ordenado: mayor â†’ menor precio</div>`:''}
    </div>
    <div class="pgrid">`;

  lista.slice(0,60).forEach((p,i)=>{
    const tip=get(p,'tipo de inmueble','tipo')||'Inmueble';
    const dir=get(p,'direccion','direcciÃ³n')||'Sin direcciÃ³n';
    const ciu=get(p,'ubicaci','ciudad')||'';
    const cod=get(p,'cÃ³digo','codigo','metrocuadrado')||'';
    const asesor=get(p,'asesor responsable','asesor')||'';
    const obs=get(p,'observaciones','observacion')||'';
    const estado=get(p,'estado actual','estado')||'DISPONIBLE';
    const pv=pVenta(p);
    const pa=pArriendo(p);
    const admon=num(get(p,'administraci','admon'));
    const area=get(p,'Ã¡rea construida','area construida','Ã¡rea','area')||'';
    const hab=get(p,'habitaciones')||'';
    const ban=get(p,'baÃ±os','banos')||'';
    const est=get(p,'estrato')||'';
    const ant=get(p,'antigÃ¼edad','antiguedad')||'';

    const ambas=eA2(p);
    const soloV=eV(p)&&!ambas;
    const soloA=eA(p)&&!ambas;
    const emoji=getEmoji(tip);
    const headCls=ambas?'tb':soloV?'tv':'ta';

    // Badges de modalidad
    let mods='';
    if(soloV||ambas) mods+=`<span class="mbadge mbv">ğŸ’° Venta</span>`;
    if(soloA||ambas) mods+=`<span class="mbadge mba">ğŸ”‘ Arriendo</span>`;
    mods+=`<span class="mbadge ${estado.includes('DISPONIBLE')?'mbok':'mbst'}">${estado.includes('DISPONIBLE')?'âœ… Disponible':'ğŸ“Œ '+estado}</span>`;

    // Bloque de precios - con indicadores cruzados
    let pricesH='<div class="pblock">';

    if(pv>0){
      pricesH+=`<div class="pventa">${fmt(pv)} <small>precio venta</small></div>`;
      // Si consulta es de arriendo y este predio TAMBIÃ‰N tiene arriendo mostrar cross
      if(esArriendo&&pa>0){
        pricesH+=`<span class="cross-a">ğŸ”‘ TambiÃ©n en arriendo: ${fmt(pa)}/mes</span>`;
      }
    }
    if(pa>0){
      pricesH+=`<div class="parriendo">ğŸ”‘ ${fmt(pa)}<small>/mes arriendo</small></div>`;
      // Si consulta es de venta y este predio TAMBIÃ‰N tiene venta mostrar cross
      if(!esArriendo&&pv>0&&pa>0&&!soloA){
        pricesH+=`<span class="cross-v">ğŸ’° TambiÃ©n en venta: ${fmt(pv)}</span>`;
      }
    }
    if(admon>0) pricesH+=`<div class="admon">ğŸ¢ Admon: ${fmt(admon)}</div>`;
    pricesH+='</div>';

    // Alerta doble modalidad
    const dualH=ambas?`<div class="dalert">âš ï¸ <strong>Doble modalidad:</strong> VENTA ${pv>0?fmt(pv):'(consultar)'} | ARRIENDO ${pa>0?fmt(pa)+'/mes':'(consultar)'}. Informe ambas opciones al cliente.</div>`:'';

    // Specs tÃ©cnicos
    const specs=[
      hab&&hab!='0'?`<span class="spec">ğŸ›ï¸ ${hab} hab</span>`:'',
      ban&&ban!='0'?`<span class="spec">ğŸš¿ ${ban} baÃ±os</span>`:'',
      area?`<span class="spec">ğŸ“ ${area} mÂ²</span>`:'',
      est&&est!='SIN INFORMACION'?`<span class="spec">â­ Est. ${est}</span>`:'',
      ant&&ant!='SIN INFORMACION'?`<span class="spec">ğŸ• ${ant}</span>`:'',
    ].filter(Boolean).join('');

    const obsH=obs&&obs.length>3?`<div class="obs">ğŸ“ ${obs.slice(0,150)}${obs.length>150?'â€¦':''}</div>`:'';
    const asesorH=asesor?`<div class="asesor">ğŸ‘¤ Asesor: <strong>${asesor}</strong></div>`:'';

    h+=`
    <div class="pc" style="animation-delay:${Math.min(i*0.04,0.8)}s">
      <div class="pctop ${headCls}">
        ${cod?`<span class="pccod">${cod}</span>`:''}
        <div class="pcemoji">${emoji}</div>
        <div class="pctipo">${tip}</div>
        <div class="pcdir">${dir}</div>
        <div class="pccity">ğŸ“ ${ciu}</div>
      </div>
      <div class="pcbody">
        <div class="mods">${mods}</div>
        ${pricesH}
        ${specs?`<div class="specs">${specs}</div>`:''}
        ${dualH}
        ${obsH}
        ${asesorH}
      </div>
    </div>`;
  });

  h+='</div>';
  res.innerHTML=h;
  setTimeout(()=>res.scrollIntoView({behavior:'smooth',block:'start'}),100);
}

function fmt(n){
  if(!n||n<=0)return null;
  if(n>=1000000000)return '$'+(n/1000000000).toFixed(1).replace(/\.0$/,'')+'B';
  if(n>=1000000)return '$'+Math.round(n/1000000).toLocaleString('es-CO')+'M';
  return '$'+Math.round(n).toLocaleString('es-CO');
}

function getEmoji(t){
  t=(t||'').toLowerCase();
  if(t.includes('penthouse'))return 'ğŸ‘‘';
  if(t.includes('campestre'))return 'ğŸŒ¿';
  if(t.includes('finca'))return 'ğŸŒ¾';
  if(t.includes('estudio'))return 'ğŸ ';
  if(t.includes('apto')||t.includes('apartamento'))return 'ğŸ¢';
  if(t.includes('casa'))return 'ğŸ¡';
  if(t.includes('local'))return 'ğŸª';
  if(t.includes('oficina'))return 'ğŸ’¼';
  if(t.includes('lote')||t.includes('terreno'))return 'ğŸŒ³';
  if(t.includes('bodega'))return 'ğŸ­';
  return 'ğŸ ';
}
</script>
</body>
</html>
