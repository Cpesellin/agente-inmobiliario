<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Agente Inmobiliario IA</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700;900&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet"/>
<style>
  :root {
    --bg: #0d0f14;
    --surface: #161920;
    --surface2: #1e222d;
    --border: #2a2f3d;
    --gold: #c9a84c;
    --gold-light: #e8c97a;
    --gold-dim: rgba(201,168,76,0.15);
    --text: #f0ece4;
    --text-muted: #7a8099;
    --text-dim: #4a5068;
    --green: #4caf7d;
    --blue: #4a90d9;
    --red: #e05252;
    --radius: 12px;
  }

  * { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* BACKGROUND TEXTURE */
  body::before {
    content: '';
    position: fixed; inset: 0;
    background:
      radial-gradient(ellipse 80% 60% at 20% 0%, rgba(201,168,76,0.06) 0%, transparent 60%),
      radial-gradient(ellipse 60% 40% at 80% 100%, rgba(74,144,217,0.04) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
  }

  /* â”€â”€â”€â”€â”€ LAYOUT â”€â”€â”€â”€â”€ */
  .app { position: relative; z-index: 1; display: flex; flex-direction: column; min-height: 100vh; max-width: 960px; margin: 0 auto; padding: 0 16px; }

  /* â”€â”€â”€â”€â”€ HEADER â”€â”€â”€â”€â”€ */
  header {
    padding: 28px 0 20px;
    display: flex; align-items: center; gap: 16px;
    border-bottom: 1px solid var(--border);
  }
  .logo-mark {
    width: 44px; height: 44px;
    background: linear-gradient(135deg, var(--gold), var(--gold-light));
    border-radius: 10px;
    display: flex; align-items: center; justify-content: center;
    font-family: 'Playfair Display', serif;
    font-weight: 900; font-size: 22px; color: #0d0f14;
    flex-shrink: 0;
  }
  .brand h1 {
    font-family: 'Playfair Display', serif;
    font-size: 20px; font-weight: 700;
    letter-spacing: -0.3px;
    color: var(--text);
  }
  .brand p { font-size: 12px; color: var(--text-muted); font-weight: 300; }
  .status-pill {
    margin-left: auto;
    display: flex; align-items: center; gap: 6px;
    background: var(--surface2); border: 1px solid var(--border);
    border-radius: 20px; padding: 6px 12px;
    font-size: 11px; color: var(--text-muted);
  }
  .status-dot {
    width: 7px; height: 7px; border-radius: 50%;
    background: var(--text-dim);
    transition: background 0.3s, box-shadow 0.3s;
  }
  .status-dot.connected { background: var(--green); box-shadow: 0 0 8px rgba(76,175,125,0.6); }
  .status-dot.error { background: var(--red); }

  /* â”€â”€â”€â”€â”€ CONFIG PANEL â”€â”€â”€â”€â”€ */
  .config-panel {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px 24px;
    margin: 20px 0 0;
    display: grid; grid-template-columns: 1fr 1fr; gap: 12px;
  }
  .config-panel h3 {
    grid-column: 1/-1;
    font-size: 11px; font-weight: 600;
    letter-spacing: 1.2px; text-transform: uppercase;
    color: var(--gold); margin-bottom: 4px;
  }
  .field { display: flex; flex-direction: column; gap: 5px; }
  .field.full { grid-column: 1/-1; }
  label { font-size: 11px; color: var(--text-muted); font-weight: 500; }
  input, select {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 8px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 13px;
    padding: 9px 12px;
    outline: none;
    transition: border-color 0.2s;
  }
  input:focus, select:focus { border-color: var(--gold); }
  input::placeholder { color: var(--text-dim); }

  .btn-connect {
    grid-column: 1/-1;
    background: linear-gradient(135deg, var(--gold), var(--gold-light));
    border: none; border-radius: 8px;
    color: #0d0f14; font-family: 'DM Sans', sans-serif;
    font-weight: 600; font-size: 13px;
    padding: 11px;
    cursor: pointer;
    transition: opacity 0.2s, transform 0.1s;
  }
  .btn-connect:hover { opacity: 0.9; transform: translateY(-1px); }
  .btn-connect:active { transform: translateY(0); }

  /* â”€â”€â”€â”€â”€ SUGGESTED QUERIES â”€â”€â”€â”€â”€ */
  .suggestions {
    display: flex; flex-wrap: wrap; gap: 8px;
    margin: 16px 0 0;
  }
  .suggestion-chip {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 20px;
    padding: 7px 14px;
    font-size: 12px; color: var(--text-muted);
    cursor: pointer;
    transition: border-color 0.2s, color 0.2s, background 0.2s;
    white-space: nowrap;
  }
  .suggestion-chip:hover {
    border-color: var(--gold); color: var(--gold);
    background: var(--gold-dim);
  }

  /* â”€â”€â”€â”€â”€ CHAT AREA â”€â”€â”€â”€â”€ */
  .chat-area {
    flex: 1;
    overflow-y: auto;
    padding: 20px 0;
    display: flex; flex-direction: column; gap: 16px;
    min-height: 300px;
  }
  .chat-area::-webkit-scrollbar { width: 4px; }
  .chat-area::-webkit-scrollbar-track { background: transparent; }
  .chat-area::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  /* Messages */
  .message { display: flex; gap: 12px; animation: fadeUp 0.3s ease; }
  @keyframes fadeUp { from { opacity:0; transform: translateY(8px); } to { opacity:1; transform: translateY(0); } }

  .message.user { flex-direction: row-reverse; }

  .avatar {
    width: 34px; height: 34px; border-radius: 50%;
    flex-shrink: 0; display: flex; align-items: center; justify-content: center;
    font-size: 14px; font-weight: 700;
  }
  .avatar.agent {
    background: linear-gradient(135deg, var(--gold), var(--gold-light));
    color: #0d0f14;
  }
  .avatar.user { background: var(--surface2); border: 1px solid var(--border); color: var(--text-muted); }

  .bubble {
    max-width: 78%;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 14px;
    padding: 14px 16px;
    font-size: 14px; line-height: 1.6;
  }
  .message.user .bubble {
    background: var(--gold-dim);
    border-color: rgba(201,168,76,0.3);
  }

  /* Property Cards */
  .properties-grid {
    display: grid; grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 12px; margin-top: 12px;
  }
  .property-card {
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    transition: border-color 0.2s, transform 0.2s;
    cursor: pointer;
  }
  .property-card:hover { border-color: var(--gold); transform: translateY(-2px); }

  .card-img {
    height: 130px; background: var(--bg);
    display: flex; align-items: center; justify-content: center;
    font-size: 36px;
    position: relative;
    overflow: hidden;
  }
  .card-img::after {
    content: '';
    position: absolute; inset: 0;
    background: linear-gradient(to bottom, transparent 50%, var(--surface2));
  }

  .dual-badge {
    position: absolute; top: 8px; right: 8px;
    background: linear-gradient(135deg, #7b3fe4, #4a90d9);
    border-radius: 6px; padding: 3px 8px;
    font-size: 9px; font-weight: 700; color: #fff;
    letter-spacing: 0.5px; z-index: 1;
  }

  .card-body { padding: 12px 14px 14px; }
  .card-id { font-size: 10px; color: var(--text-dim); letter-spacing: 0.5px; margin-bottom: 4px; }
  .card-name { font-family: 'Playfair Display', serif; font-size: 15px; font-weight: 700; margin-bottom: 6px; }
  .card-location { font-size: 12px; color: var(--text-muted); margin-bottom: 10px; }

  .card-badges { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px; }
  .badge {
    border-radius: 5px; padding: 3px 8px;
    font-size: 10px; font-weight: 600;
  }
  .badge.venta { background: rgba(76,175,125,0.15); color: var(--green); border: 1px solid rgba(76,175,125,0.3); }
  .badge.renta { background: rgba(74,144,217,0.15); color: var(--blue); border: 1px solid rgba(74,144,217,0.3); }
  .badge.dual { background: rgba(123,63,228,0.15); color: #a07ae8; border: 1px solid rgba(123,63,228,0.3); }

  .card-price { font-size: 16px; font-weight: 700; color: var(--gold); }
  .card-price small { font-size: 11px; color: var(--text-muted); font-weight: 400; }
  .card-price-rent { font-size: 13px; color: var(--blue); margin-top: 2px; }

  .card-specs { display: flex; gap: 10px; margin-top: 8px; }
  .spec { font-size: 11px; color: var(--text-muted); display: flex; align-items: center; gap: 3px; }

  .dual-note {
    background: rgba(123,63,228,0.1);
    border: 1px solid rgba(123,63,228,0.3);
    border-radius: 6px;
    padding: 6px 10px;
    font-size: 11px;
    color: #a07ae8;
    margin-top: 8px;
    line-height: 1.4;
  }

  /* Summary bar */
  .summary-bar {
    background: var(--gold-dim);
    border: 1px solid rgba(201,168,76,0.25);
    border-radius: 8px; padding: 10px 14px;
    font-size: 12px; color: var(--gold-light);
    margin-bottom: 10px;
  }

  /* Thinking indicator */
  .thinking { display: flex; gap: 5px; align-items: center; padding: 4px 0; }
  .thinking-dot {
    width: 7px; height: 7px; border-radius: 50%;
    background: var(--gold); opacity: 0.4;
    animation: pulse 1.2s infinite;
  }
  .thinking-dot:nth-child(2) { animation-delay: 0.2s; }
  .thinking-dot:nth-child(3) { animation-delay: 0.4s; }
  @keyframes pulse { 0%,100%{opacity:0.2;transform:scale(0.8)} 50%{opacity:1;transform:scale(1.1)} }

  /* â”€â”€â”€â”€â”€ INPUT BAR â”€â”€â”€â”€â”€ */
  .input-area {
    padding: 16px 0 24px;
    border-top: 1px solid var(--border);
  }
  .input-row {
    display: flex; gap: 10px; align-items: flex-end;
  }
  .input-wrap { flex: 1; position: relative; }
  textarea {
    width: 100%;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    padding: 13px 50px 13px 16px;
    outline: none;
    resize: none;
    min-height: 48px; max-height: 130px;
    transition: border-color 0.2s;
    overflow-y: auto;
    line-height: 1.5;
  }
  textarea:focus { border-color: var(--gold); }
  textarea::placeholder { color: var(--text-dim); }

  .btn-send {
    position: absolute; right: 10px; bottom: 9px;
    width: 32px; height: 32px;
    background: linear-gradient(135deg, var(--gold), var(--gold-light));
    border: none; border-radius: 8px;
    cursor: pointer;
    display: flex; align-items: center; justify-content: center;
    transition: opacity 0.2s, transform 0.1s;
  }
  .btn-send:hover { opacity: 0.9; transform: scale(1.05); }
  .btn-send:disabled { opacity: 0.4; cursor: not-allowed; transform: none; }
  .btn-send svg { width: 15px; height: 15px; fill: #0d0f14; }

  /* Detail modal */
  .modal-overlay {
    position: fixed; inset: 0;
    background: rgba(0,0,0,0.75);
    z-index: 100;
    display: flex; align-items: center; justify-content: center;
    padding: 20px;
    animation: fadeIn 0.2s;
  }
  @keyframes fadeIn { from{opacity:0} to{opacity:1} }
  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    max-width: 520px; width: 100%;
    max-height: 85vh; overflow-y: auto;
    padding: 28px;
  }
  .modal h2 { font-family: 'Playfair Display', serif; font-size: 22px; margin-bottom: 6px; }
  .modal-close {
    float: right; background: var(--surface2); border: 1px solid var(--border);
    border-radius: 6px; padding: 4px 10px;
    cursor: pointer; color: var(--text-muted); font-size: 12px;
    margin-top: -4px;
  }
  .modal-section { margin-top: 16px; }
  .modal-section h4 { font-size: 10px; letter-spacing: 1px; text-transform: uppercase; color: var(--gold); margin-bottom: 10px; }
  .modal-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
  .modal-item { background: var(--surface2); border-radius: 8px; padding: 10px 12px; }
  .modal-item .mi-label { font-size: 10px; color: var(--text-dim); margin-bottom: 3px; }
  .modal-item .mi-val { font-size: 14px; font-weight: 600; }

  /* â”€â”€â”€â”€â”€ DISCLAIMER â”€â”€â”€â”€â”€ */
  .disclaimer {
    font-size: 11px; color: var(--text-dim);
    text-align: center; padding: 0 0 10px;
    line-height: 1.5;
  }

  /* RESPONSIVE */
  @media (max-width:600px) {
    .config-panel { grid-template-columns: 1fr; }
    .config-panel h3, .btn-connect { grid-column: 1; }
    .field.full { grid-column: 1; }
    .properties-grid { grid-template-columns: 1fr; }
    .modal-grid { grid-template-columns: 1fr; }
  }
</style>
</head>
<body>
<div class="app">

  <!-- HEADER -->
  <header>
    <div class="logo-mark">R</div>
    <div class="brand">
      <h1>Agente Inmobiliario IA</h1>
      <p>Consultas en tiempo real Â· Google Sheets</p>
    </div>
    <div class="status-pill">
      <div class="status-dot" id="statusDot"></div>
      <span id="statusText">Sin conectar</span>
    </div>
  </header>

  <!-- CONFIG PANEL -->
  <div class="config-panel" id="configPanel">
    <h3>âš™ ConfiguraciÃ³n de conexiÃ³n</h3>

    <div class="field full">
      <label>URL pÃºblica de Google Sheets (CSV)</label>
      <input type="text" id="sheetsUrl" value="https://docs.google.com/spreadsheets/d/e/2PACX-1vRDLV71BFzFH90WHKcp9D0xxMu5SjeLNrHLlWoJxj74-SHEg7ZZlFORnKzOM1bgZCIsG6lF-iWOZltD/pub?gid=1657130181&amp;single=true&amp;output=csv" placeholder="https://docs.google.com/spreadsheets/d/â€¦/export?format=csv"/>
    </div>

    <div class="field">
      <label>Nombre de la empresa</label>
      <input type="text" id="companyName" value="Inmobiliaria"/>
    </div>

    <div class="field">
      <label>Moneda</label>
      <select id="currency">
        <option value="COP">COP ($ pesos)</option>
        <option value="USD">USD ($)</option>
        <option value="EUR">EUR (â‚¬)</option>
      </select>
    </div>

    <button class="btn-connect" onclick="connectSheets()">ğŸ”— Conectar y cargar predios</button>
  </div>

  <!-- SUGGESTIONS -->
  <div class="suggestions" id="suggestions">
    <span class="suggestion-chip" onclick="useSuggestion(this)">ğŸ  Apartamentos en venta</span>
    <span class="suggestion-chip" onclick="useSuggestion(this)">ğŸ”‘ Locales en arriendo</span>
    <span class="suggestion-chip" onclick="useSuggestion(this)">ğŸ’° Predios entre 200 y 500 millones</span>
    <span class="suggestion-chip" onclick="useSuggestion(this)">ğŸ¢ Casas disponibles para venta o renta</span>
    <span class="suggestion-chip" onclick="useSuggestion(this)">ğŸ“‹ Ver todos los predios disponibles</span>
  </div>

  <!-- CHAT AREA -->
  <div class="chat-area" id="chatArea">
    <div class="message">
      <div class="avatar agent">R</div>
      <div class="bubble">
        <strong style="color:var(--gold)">Â¡Bienvenido al Agente Inmobiliario IA!</strong><br/><br/>
        Soy tu asistente para consultar predios disponibles. Puedo ayudarte a encontrar opciones de <strong>venta</strong>, <strong>renta</strong> o predios con <strong>ambas modalidades</strong>.<br/><br/>
        ğŸ‘† Primero conecta tu Google Sheets arriba, luego hazme cualquier consulta. Puedes preguntarme por ubicaciÃ³n, precio, tipo de inmueble, Ã¡rea y mÃ¡s.
      </div>
    </div>
  </div>

  <!-- INPUT BAR -->
  <div class="input-area">
    <div class="input-row">
      <div class="input-wrap">
        <textarea id="userInput" rows="1" placeholder="Ej: Busco apartamento en el norte, mÃ¡ximo 300 millonesâ€¦" onkeydown="handleKey(event)" oninput="autoResize(this)"></textarea>
        <button class="btn-send" id="sendBtn" onclick="sendMessage()" title="Enviar">
          <svg viewBox="0 0 24 24"><path d="M2 21l21-9L2 3v7l15 2-15 2z"/></svg>
        </button>
      </div>
    </div>
    <p class="disclaimer" style="margin-top:8px">La informaciÃ³n proviene directamente de tu Google Sheets. Verifica siempre la disponibilidad antes de informar al cliente.</p>
  </div>

</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay" style="display:none" onclick="closeModalIfOutside(event)">
  <div class="modal" id="modalContent"></div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let sheetsData = [];
let isConnected = false;
let isThinking = false;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONNECT SHEETS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function connectSheets() {
  const url = document.getElementById('sheetsUrl').value.trim();
  if (!url) {
    addMessage('agent', 'âš ï¸ Por favor ingresa la URL de tu Google Sheets antes de conectar.');
    return;
  }

  setStatus('connecting');
  addMessage('agent', '<div class="thinking"><div class="thinking-dot"></div><div class="thinking-dot"></div><div class="thinking-dot"></div></div>');

  // CORS proxy list - tries each one until one works
  const proxies = [
    (u) => `https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
    (u) => `https://corsproxy.io/?${encodeURIComponent(u)}`,
    (u) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}`,
  ];

  let text = null;
  let lastError = '';

  for (const proxyFn of proxies) {
    try {
      const proxyUrl = proxyFn(url);
      const resp = await fetch(proxyUrl, { signal: AbortSignal.timeout(10000) });
      if (!resp.ok) { lastError = `HTTP ${resp.status}`; continue; }
      const t = await resp.text();
      if (t && t.length > 10 && !t.startsWith('<')) {
        text = t; break;
      } else {
        lastError = 'Respuesta vacÃ­a o HTML';
      }
    } catch(e) { lastError = e.message; }
  }

  removeThinking();

  if (!text) {
    setStatus('error');
    addMessage('agent', `âŒ <strong>No se pudo cargar el Sheet.</strong> Ãšltimo error: ${lastError}<br/><br/>
    Soluciones:<br/>
    1. Verifica que la hoja estÃ© publicada: <em>Archivo â†’ Publicar en la web â†’ Respuestas de formulario 2 â†’ CSV â†’ Publicar</em><br/>
    2. Intenta abrir directamente esta URL en tu navegador:<br/>
    <a href="${url}" target="_blank" style="color:var(--gold);font-size:11px;word-break:break-all">${url}</a><br/>
    Si ves datos CSV allÃ­, el problema es CORS del navegador.`);
    return;
  }

  sheetsData = parseCSV(text);
  setStatus('connected');
  isConnected = true;

  const company = document.getElementById('companyName').value || 'la empresa';
  addMessage('agent', `âœ… <strong>ConexiÃ³n exitosa</strong> â€” Se cargaron <strong>${sheetsData.length} predios</strong> de ${company}.<br/><br/>
  Puedes consultar:<br/>
  â€¢ Â¿QuÃ© apartamentos hay en venta?<br/>
  â€¢ Casas disponibles para renta bajo 3 millones<br/>
  â€¢ Predios con opciÃ³n de venta y arriendo<br/>
  â€¢ MuÃ©strame todo lo disponible en [barrio]`);

  document.getElementById('configPanel').style.opacity = '0.6';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SEND MESSAGE & CALL CLAUDE API
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function sendMessage() {
  const input = document.getElementById('userInput');
  const query = input.value.trim();
  if (!query || isThinking) return;

  input.value = '';
  autoResize(input);
  addMessage('user', escapeHtml(query));

  if (!isConnected || sheetsData.length === 0) {
    addMessage('agent', 'âš ï¸ AÃºn no has conectado tu Google Sheets. Completa la configuraciÃ³n arriba primero.');
    return;
  }

  isThinking = true;
  document.getElementById('sendBtn').disabled = true;
  addMessage('agent', '<div class="thinking"><div class="thinking-dot"></div><div class="thinking-dot"></div><div class="thinking-dot"></div></div>', 'thinking-msg');

  try {
    const currency = document.getElementById('currency').value;
    const company = document.getElementById('companyName').value || 'la empresa';

    // Build data context (limit rows to avoid huge prompts)
    const maxRows = Math.min(sheetsData.length, 80);
    const dataStr = JSON.stringify(sheetsData.slice(0, maxRows), null, 1);

    const systemPrompt = `Eres un agente inmobiliario experto de ${company}. 
Tu trabajo es responder consultas sobre predios disponibles basÃ¡ndote ÃšNICAMENTE en los datos reales proporcionados.

DATOS ACTUALES DE PREDIOS (${sheetsData.length} registros):
${dataStr}

REGLAS CRÃTICAS:
1. Solo menciona predios que EXISTEN en los datos anteriores. NUNCA inventes propiedades.
2. Si un predio tiene condiciÃ³n "ambas" (venta Y renta): 
   - Si preguntan por venta â†’ muÃ©stralo y agrega nota: "âš ï¸ Este predio tambiÃ©n estÃ¡ disponible en ARRIENDO"
   - Si preguntan por renta/arriendo â†’ muÃ©stralo y agrega nota: "âš ï¸ Este predio tambiÃ©n estÃ¡ disponible en VENTA"
3. Moneda: ${currency}. Formatea precios con separadores de miles.
4. Si no hay resultados que coincidan, dilo claramente y sugiere alternativas de los datos.
5. SÃ© especÃ­fico y conciso. Usa los datos exactos del sheet (Ã¡rea, habitaciones, baÃ±os, precio, etc.)
6. Al listar predios, responde en JSON con este formato EXACTO (para renderizado visual):
{"type":"properties","summary":"texto breve","items":[{"id":"...","nombre":"...","tipo":"...","condicion":"venta|renta|ambas","barrio":"...","ciudad":"...","area":"...","habitaciones":"...","banos":"...","precio_venta":"...","precio_renta":"...","descripcion":"...","link":"...","emoji":"ğŸ "}]}
7. Si la consulta es general o no requiere lista de predios, responde en texto normal.
8. Siempre mantÃ©n coherencia: los precios, Ã¡reas y disponibilidad deben coincidir exactamente con los datos.`;

    const response = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: 1000,
        system: systemPrompt,
        messages: [{ role: "user", content: query }]
      })
    });

    const data = await response.json();
    const raw = data.content?.map(b => b.text || '').join('') || '';

    removeThinking();

    // Try to parse as property list
    try {
      const jsonMatch = raw.match(/\{[\s\S]*"type"\s*:\s*"properties"[\s\S]*\}/);
      if (jsonMatch) {
        const parsed = JSON.parse(jsonMatch[0]);
        renderProperties(parsed);
      } else {
        addMessage('agent', formatText(raw));
      }
    } catch(_) {
      addMessage('agent', formatText(raw));
    }

  } catch(e) {
    removeThinking();
    addMessage('agent', 'âŒ Error al consultar el agente: ' + e.message);
  }

  isThinking = false;
  document.getElementById('sendBtn').disabled = false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER PROPERTIES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderProperties(data) {
  const { summary, items } = data;
  if (!items || items.length === 0) {
    addMessage('agent', 'ğŸ” No encontrÃ© predios que coincidan con tu bÃºsqueda. Intenta con otros criterios.');
    return;
  }

  const isDual = cond => cond && cond.toLowerCase() === 'ambas';
  const currency = document.getElementById('currency').value;
  const sym = currency === 'EUR' ? 'â‚¬' : '$';

  let html = `<div class="summary-bar">ğŸ” ${escapeHtml(summary || `${items.length} predio(s) encontrado(s)`)}</div>`;
  html += `<div class="properties-grid">`;

  items.forEach(p => {
    const dual = isDual(p.condicion);
    const condBadge = dual
      ? `<span class="badge dual">âœ¦ Venta & Renta</span>`
      : p.condicion?.toLowerCase().includes('venta')
        ? `<span class="badge venta">Venta</span>`
        : `<span class="badge renta">Arriendo</span>`;

    const emoji = p.emoji || 'ğŸ ';
    const specs = [
      p.area ? `ğŸ“ ${p.area}` : '',
      p.habitaciones ? `ğŸ› ${p.habitaciones}` : '',
      p.banos ? `ğŸš¿ ${p.banos}` : ''
    ].filter(Boolean).join('  ');

    const dualnote = dual
      ? `<div class="dual-note">â„¹ï¸ Este predio tambiÃ©n estÃ¡ disponible en la otra modalidad. Consultar condiciones.</div>`
      : '';

    html += `
    <div class="property-card" onclick="showDetail(${encodeURIComponent(JSON.stringify(p))})">
      <div class="card-img">
        ${dual ? '<span class="dual-badge">VENTA + RENTA</span>' : ''}
        <span>${emoji}</span>
      </div>
      <div class="card-body">
        <div class="card-id">${escapeHtml(p.id || '')}</div>
        <div class="card-name">${escapeHtml(p.nombre || 'Sin nombre')}</div>
        <div class="card-location">ğŸ“ ${escapeHtml([p.barrio, p.ciudad].filter(Boolean).join(', ') || 'UbicaciÃ³n no especificada')}</div>
        <div class="card-badges">${condBadge}</div>
        ${p.precio_venta ? `<div class="card-price">${sym}${formatNum(p.precio_venta)} <small>venta</small></div>` : ''}
        ${p.precio_renta ? `<div class="card-price-rent">${sym}${formatNum(p.precio_renta)}<small>/mes arriendo</small></div>` : ''}
        ${specs ? `<div class="card-specs"><span class="spec">${specs}</span></div>` : ''}
        ${dualnote}
      </div>
    </div>`;
  });

  html += `</div>`;
  addMessage('agent', html);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SHOW DETAIL MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showDetail(encoded) {
  const p = JSON.parse(decodeURIComponent(encoded));
  const currency = document.getElementById('currency').value;
  const sym = currency === 'EUR' ? 'â‚¬' : '$';
  const dual = p.condicion?.toLowerCase() === 'ambas';

  const fields = [
    ['Tipo', p.tipo], ['Ãrea', p.area], ['Habitaciones', p.habitaciones],
    ['BaÃ±os', p.banos], ['Piso', p.piso], ['Estrato', p.estrato],
    ['Estado', p.estado], ['CondiciÃ³n', p.condicion],
  ].filter(f => f[1]);

  let html = `
  <button class="modal-close" onclick="closeModal()">âœ• Cerrar</button>
  <h2>${escapeHtml(p.nombre || 'Predio')}</h2>
  <p style="color:var(--text-muted);font-size:13px;margin-top:4px">ğŸ“ ${escapeHtml([p.barrio, p.ciudad].filter(Boolean).join(', ') || '')}</p>

  ${dual ? `<div class="dual-note" style="margin-top:12px">âš ï¸ <strong>Predio con doble modalidad:</strong> disponible tanto en VENTA como en ARRIENDO. Informe al cliente ambas opciones.</div>` : ''}

  <div class="modal-section">
    <h4>Precios</h4>
    <div class="modal-grid">
      ${p.precio_venta ? `<div class="modal-item"><div class="mi-label">Precio Venta</div><div class="mi-val" style="color:var(--green)">${sym}${formatNum(p.precio_venta)}</div></div>` : ''}
      ${p.precio_renta ? `<div class="modal-item"><div class="mi-label">Canon Arriendo/mes</div><div class="mi-val" style="color:var(--blue)">${sym}${formatNum(p.precio_renta)}</div></div>` : ''}
    </div>
  </div>

  <div class="modal-section">
    <h4>CaracterÃ­sticas</h4>
    <div class="modal-grid">
      ${fields.map(f => `<div class="modal-item"><div class="mi-label">${f[0]}</div><div class="mi-val">${escapeHtml(String(f[1]))}</div></div>`).join('')}
    </div>
  </div>

  ${p.descripcion ? `<div class="modal-section"><h4>DescripciÃ³n</h4><p style="font-size:13px;line-height:1.6;color:var(--text-muted)">${escapeHtml(p.descripcion)}</p></div>` : ''}

  ${p.link ? `<div class="modal-section"><a href="${escapeHtml(p.link)}" target="_blank" style="color:var(--gold);font-size:13px">ğŸ”— Ver ficha completa â†’</a></div>` : ''}
  `;

  document.getElementById('modalContent').innerHTML = html;
  document.getElementById('modalOverlay').style.display = 'flex';
}

function closeModal() { document.getElementById('modalOverlay').style.display = 'none'; }
function closeModalIfOutside(e) { if(e.target === document.getElementById('modalOverlay')) closeModal(); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CSV PARSER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function parseCSV(text) {
  const lines = text.trim().split('\n');
  if (lines.length < 2) return [];
  const headers = parseCSVRow(lines[0]).map(h => h.trim().toLowerCase().replace(/\s+/g,'_'));
  const rows = [];
  for (let i = 1; i < lines.length; i++) {
    const vals = parseCSVRow(lines[i]);
    if (vals.every(v => !v.trim())) continue;
    const obj = {};
    headers.forEach((h,j) => obj[h] = (vals[j] || '').trim());
    // Map common column names to standard keys
    rows.push(normalizeRow(obj));
  }
  return rows;
}

function parseCSVRow(line) {
  const result = []; let cur = ''; let inQ = false;
  for (let i = 0; i < line.length; i++) {
    const c = line[i];
    if (c === '"') { inQ = !inQ; }
    else if (c === ',' && !inQ) { result.push(cur); cur = ''; }
    else cur += c;
  }
  result.push(cur); return result;
}

function normalizeRow(obj) {
  // Map flexible column names to standard ones
  const maps = {
    nombre: ['nombre','name','inmueble','predio','propiedad','titulo'],
    tipo: ['tipo','type','categoria','clase'],
    condicion: ['condicion','condiciÃ³n','modalidad','disponibilidad','tipo_oferta'],
    estado: ['estado','status','disponible'],
    barrio: ['barrio','sector','zona','neighborhood'],
    ciudad: ['ciudad','city','municipio'],
    area: ['area','Ã¡rea','m2','metros','metros_cuadrados'],
    habitaciones: ['habitaciones','hab','cuartos','alcobas','rooms','bedrooms'],
    banos: ['baÃ±os','banos','bathrooms','wc'],
    precio_venta: ['precio_venta','venta','valor_venta','precio','price'],
    precio_renta: ['precio_renta','renta','arriendo','canon','mensualidad'],
    descripcion: ['descripcion','descripciÃ³n','description','detalle','detalles'],
    link: ['link','url','foto','enlace'],
    id: ['id','codigo','cÃ³digo','ref','referencia'],
    estrato: ['estrato','stratum'],
    piso: ['piso','floor'],
  };

  const norm = {...obj};
  for (const [std, candidates] of Object.entries(maps)) {
    if (!norm[std]) {
      for (const c of candidates) {
        if (obj[c] !== undefined) { norm[std] = obj[c]; break; }
      }
    }
  }
  // Emoji by type
  const t = (norm.tipo||'').toLowerCase();
  norm.emoji = t.includes('casa') ? 'ğŸ¡' : t.includes('local') ? 'ğŸª' :
               t.includes('oficina') ? 'ğŸ¢' : t.includes('lote') ? 'ğŸŒ³' :
               t.includes('bodega') ? 'ğŸ­' : 'ğŸ ';
  return norm;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addMessage(role, html, id) {
  const chat = document.getElementById('chatArea');
  const div = document.createElement('div');
  div.className = `message ${role}`;
  if(id) div.id = id;
  const avatar = role === 'agent'
    ? `<div class="avatar agent">R</div>`
    : `<div class="avatar user">U</div>`;
  div.innerHTML = `${avatar}<div class="bubble">${html}</div>`;
  chat.appendChild(div);
  chat.scrollTop = chat.scrollHeight;
}

function removeThinking() {
  const el = document.getElementById('thinking-msg');
  if (el) el.remove();
}

function setStatus(state) {
  const dot = document.getElementById('statusDot');
  const text = document.getElementById('statusText');
  if(state==='connected') { dot.className='status-dot connected'; text.textContent='Conectado'; }
  else if(state==='error') { dot.className='status-dot error'; text.textContent='Error'; }
  else { dot.className='status-dot'; text.textContent='Conectandoâ€¦'; }
}

function formatNum(val) {
  const n = parseFloat(String(val).replace(/[^0-9.]/g,''));
  if(isNaN(n)) return val;
  return n.toLocaleString('es-CO');
}

function formatText(text) {
  return escapeHtml(text).replace(/\*\*(.*?)\*\*/g,'<strong>$1</strong>').replace(/\n/g,'<br/>');
}

function escapeHtml(s) {
  return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function handleKey(e) {
  if(e.key==='Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
}

function autoResize(el) {
  el.style.height='auto'; el.style.height = Math.min(el.scrollHeight, 130)+'px';
}

function useSuggestion(el) {
  document.getElementById('userInput').value = el.textContent.replace(/^[^\w]+/,'').trim();
  document.getElementById('userInput').focus();
}
</script>
</body>
</html>
